# LMJCore 核心设计定义（规范版）

_——嵌入式存储内核的数据格式与行为契约_

---

## 一、基本理念

**LMJCore** 是一个基于 [LMDB](https://symas.com/lmdb/) 的嵌入式数据存储内核，其核心使命是：

> **通过全局唯一指针将任意嵌套数据结构扁平化为高效、可验证的键值对集合，实现极致性能与强一致性保障。**

本文件定义 LMJCore 内核与上层应用之间的**数据格式、存储规则与交互契约**。所有实现必须严格遵守以下规范。

---

## 二、指针系统（Pointer System）

### 2.1 指针结构规范

默认指针为 **17 字节固定长度二进制结构**：

|字段|长度|说明|
|---|---|---|
|类型前缀|1 字节|必须为 `lmjcore_entity_type` 枚举值|
|唯一编号|16 字节|全局唯一标识符（如 UUIDv4、自定义哈希等）|

> ⚠️ **强制约束**：
> 
> - 首字节语义由内核保留，用于标识实体基础类型。
> - 无论是否使用自定义指针生成器，**不得重新解释或覆盖首字节含义**。

> 🔧 **扩展建议**：  
> 如需携带额外语义（如实例 ID、版本号），应使用第 2~17 字节，**不得侵占首字节**。

---

### 2.2 实体类型枚举（保留语义）

```c
enum lmjcore_entity_type {
    LMJCORE_OBJ = 0x01,  // 普通对象（键值容器）
    LMJCORE_ARR = 0x02   // 数组（元素集合）
};
```

> 🚫 **语义保留**：  
> 此枚举值为内核保留，**禁止重新定义、重载或扩展其语义**。  
> 上层可通过成员名（如 `_type`）实现应用层类型系统。

---

### 2.3 指针生成器接口

```c
typedef int (*lmjcore_ptr_generator_fn)(void *ctx, uint8_t out[LMJCORE_PTR_LEN]);
```

**规范要求**：

- 输出缓冲区长度由编译期宏 `LMJCORE_PTR_LEN` 定义（默认为 17）。
- **`out[0]` 必须设置为有效的 `lmjcore_entity_type` 值**。
- 生成器负责填充剩余 `LMJCORE_PTR_LEN - 1` 字节，并**保证指针在实例生命周期内唯一**。
- 若传入 `NULL` 生成器，内核初始化失败，返回错误。

> ⚠️ 内核**不验证唯一性**。冲突指针将导致数据覆盖（遵循 LMDB “后写者胜”）。

---

## 三、数据存储映射（LMJCore → LMDB）

LMJCore 使用两个 LMDB 数据库协同工作：

### 3.1 `main` 数据库：命名格子区

|属性|说明|
|---|---|
|**职责**|存储实体成员的具体值|
|**Key 格式**|`[17B 对象指针][成员名]`（二进制拼接）|
|**Value 内容**|二进制安全字节数组：  <br>- 原始数据（整数、字符串等）  <br>- 或另一个 17B 指针|
|**成员名编码**|上层决定（如 UTF-8、哈希），内核视为不透明字节序列|
|**Key 长度限制**|≤ 511 字节（LMDB 默认上限）→ **成员名最大 493 字节**|
|**超限处理**|返回 `LMJCORE_ERR_MEMBER_TOO_LONG`|

> ✅ 内核不解析 Value 语义，仅负责存储与检索。

---

### 3.2 `arr` 数据库：集合袋区

|属性|说明|
|---|---|
|**职责**|存储实体的关联项列表（成员名或数组元素）|
|**Key**|实体指针（17B，对象或数组均可）|
|**Value**|成员名（对象）或元素值（数组），可为原始数据或指针|
|**重复 Key**|允许（启用 `MDB_DUPSORT`）|
|**排序行为**|**按 Value 字典序自动排序**，**不保留插入顺序**|
|**随机访问**|不支持下标访问|

> 📌 **顺序处理建议**：  
> 若需保序（如下标、时间戳），应在 Value 前缀编码排序信息（如 4 字节小端序索引），读取后由上层排序还原。

---

## 四、数据存在性与完整性规则

### 4.1 实体存在性判定

|状态|判定条件|
|---|---|
|**有效实体**|指针在 `arr` 中存在至少一个条目|
|**无效指针**|`arr` 中无对应 Key|
|**空实体**|`arr` 中存在 Key，但无任何 Value（合法状态）|

> ✅ 此规则为系统基础语义，上层可在此基础上构建缓存或懒加载策略。

---

### 4.2 成员值完整性

- **成员定义**：当且仅当其名称出现在该对象指针对应的 `arr` 条目中。
- **已赋值**：`main` 中存在对应 Key-Value。
- **缺失值（Missing Value）**：`arr` 中有成员名，但 `main` 中无值 → **合法中间状态**（如分步初始化）。
- **读取行为**：内核返回值或错误码，**不自动补默认值**。

---

### 4.3 幽灵成员（Ghost Member）

- **定义**：`main` 中存在某成员的值，但其名称**未在 `arr` 中注册**。
- **性质**：**严重数据损坏**，表明写事务原子性被破坏。
- **成因**：非标准写入路径、崩溃恢复异常等（正常流程下不可能发生）。
- **检测**：通过 `lmjcore_audit_object()` 主动扫描。
- **处理**：
    1. 立即停止写入；
    2. 调用 `lmjcore_repair_object()`（事务性修复）；
    3. 记录审计日志。

> 🔥 **警报级别**：最高。系统应具备自动熔断机制。

---

### 4.4 成员名长度限制

- `main` Key = 17B 指针 + 成员名 ≤ 511B → **成员名 ≤ 493 字节**
- 所有 `put` 操作前置校验，超限返回 `LMJCORE_ERR_MEMBER_TOO_LONG`

---

### 4.5 返回结构内存归属

- 所有返回 `{data, errors}` 的 API **写入调用方提供的缓冲区**。
- 内核**不执行堆分配**，避免跨层内存管理歧义。
- 生命周期由调用方控制。

---

### 4.6 指针持久化格式

- 工具函数输出 **34 字符小写 HEX 字符串**（无分隔符）
- 示例：`01c9f56d43417d4e78ab4bd1d6ceb3e1fb`
- 可直接用于配置文件、日志、网络传输等文本场景。

---

## 五、扩展与兼容性规范

### 5.1 指针扩展原则

|操作|合规性|说明|
|---|---|---|
|增加指针长度|✅ 允许|通过 `LMJCORE_PTR_LEN` 宏定义|
|修改首字节语义|🚫 禁止|首字节为内核保留|
|在非首字节编码扩展类型|✅ 允许|内核不解析，但需自洽|
|自定义生成逻辑|✅ 允许|必须遵守首字节约束|

> ⚠️ **兼容性警告**：不同 `LMJCORE_PTR_LEN` 的数据库**互不兼容**，必须使用独立存储路径。

---

### 5.2 类型系统扩展（正确姿势）

✅ **推荐方式**：通过成员名空间表达类型

```c
lmjcore_set_member(obj_ptr, "_type", "user_profile");
lmjcore_set_member(obj_ptr, "_version", "2");
```

✅ **也可**：在指针第 2 字节起编码应用语义

```c
ptr[0] = LMJCORE_OBJ;      // 合规：保留内核语义
ptr[1] = app_instance_id;  // 扩展：应用自定义
```

🚫 **禁止**：

```c
ptr[0] = 0x03;  // ❌ 非法：覆盖内核保留值
```

---

### 5.3 多实例支持示例

```c
// 合规多实例指针：[类型][实例ID][15B唯一ID]
uint8_t ptr[17];
ptr[0] = LMJCORE_OBJ;     // 内核类型
ptr[1] = current_instance; // 应用扩展
memcpy(&ptr[2], uuid, 15);
```

---

## 六、实施建议

### 6.1 对新应用

- 优先使用标准成员（如 `_type`, `_class`）表达元信息；
- 在 LMJCore 之上构建应用层类型系统；
- 封装工具函数隐藏指针细节。

### 6.2 对系统集成者

- 明确记录所用指针配置（长度、生成策略）；
- 不同配置视为**不同存储系统**；
- 提供数据迁移工具以支持格式演进。

---

## 七、附录：关键常量与错误码

| 符号                            | 值/说明        |
| ----------------------------- | ----------- |
| `LMJCORE_PTR_LEN`             | 默认 17       |
| `LMJCORE_ERR_MEMBER_TOO_LONG` | 成员名超 493 字节 |
| `LMJCORE_OBJ`                 | `0x01`      |
| `LMJCORE_ARR`                 | `0x02`      |

---

> ✅ **本文档为 LMJCore 行为的最终解释依据**。任何实现偏离此规范，均视为不兼容。
