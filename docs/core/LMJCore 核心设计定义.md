# LMJCore 核心设计定义

## 一、基本理念

- **LMJCore** 是一个基于 LMDB 的嵌入式数据存储内核。
- 其核心设计哲学是：通过**指针**将复杂嵌套数据结构**扁平化**存储，实现极致性能与灵活性。
- 本定义精确描述了 LMJCore 内核与上层应用交互的数据格式与规则。

## 二、指针系统（核心定义）

### 1. 指针结构
指针是一个 **17 字节** 的固定长度二进制数据结构。

| 组成部分     | 数据类型           | 长度    | 说明          |
| :------- | :------------- | :---- | :---------- |
| **类型前缀** | `uint8_t` (枚举) | 1 字节  | 标识实体类型      |
| **唯一编号** | `uint8_t[16]`  | 16 字节 | 128位全局唯一标识符 |

### 2. 类型枚举
```c
enum lmjcore_entity_type {
    LMJCORE_OBJ = 0x01,  // 普通对象
    LMJCORE_ARR = 0x02,  // 数组
};
```

### 3. 指针暴露策略
- **内核与上层交互**：默认使用 **17 字节二进制格式**，以保证最高性能。
- **可读性支持**：内核提供工具函数，用于二进制格式与可读字符串格式（如 `obj_01a2b3c4...`）的双向转换，供上层在需要时（如日志、调试）使用。
- **上层自由选择**：上层应用可根据场景决定使用二进制（性能优先）或字符串（可读性优先）格式。

## 四、数据存储映射（LMJCore 到 LMDB）

### 1. `main` 数据库
- **职责**：存储所有**单一映射**（对象成员的值）。
- **Key 构成**：`<对象指针(17字节)><成员名称(变长字节序列)>`
- **Value**：**二进制安全的字节数组 (Binary-safe Bytestring)**。其内容可以是：
    - 原始数据的二进制表示（如整数、浮点数、字符串的字节序列）。
    - 另一个数据实体的 **17字节指针**。
- **说明**：成员名称是变长字节序列，编码由上层决定（如 UTF-8 字符串或二进制哈希）。**值的类型和结构由上层应用解析，LMJCore 内核将其视为不透明的字节序列。**

### 2. `arr` 数据库
- **职责**：存储所有**列表映射**（数组元素、对象成员列表）。
- **Key**：`<列表实体指针(17字节)>`（数组指针或对象指针——用于存储该对象的成员列表）。
- **Value**：**二进制安全的字节数组 (Binary-safe Bytestring)**。表示列表中的元素，其内容可以是原始数据或指针。允许多个重复 Key。**同样，每个元素值的具体含义由上层应用解释。**
- LMJCore 不保证数组元素顺序；若需保序，请把下标或时间戳编码进 Value 头 4 B 并由上层排序。

## 五、数据存在性与完整性规则

### 5.1 对象/数组存在性判定规则
- **有效对象/数组**：当指针（类型为 `LMJCORE_OBJ` 或 `LMJCORE_ARR`）在 `arr` 数据库中存在对应条目时，该指针指向一个**有效**的数据实体。
- **无效指针**：当指针在 `arr` 数据库中不存在对应条目时，该指针为**无效指针**，不指向任何有效数据实体。
- **空对象/空数组**：当指针在 `arr` 数据库中存在，但对应的值列表为空时，表示一个**空对象**（无成员）或**空数组**（无元素）。
- 此规则是系统的基础语义，上层同步策略可在此基础上进行增强或覆盖。

### 5.2 成员值完整性规则
- **合法成员**：一个对象的合法成员必须同时满足：
  1. 其成员名称记录在该对象指针于 `arr` 数据库对应的成员列表中。
  2. 其键值对（Key = `<对象指针>:<成员名称>`）存在于 `main` 数据库中。
- **缺失值处理**：若成员在 `arr` 中定义但在 `main` 中缺失，则该成员的值为 **`null`**。
- **幽灵成员禁止**：任何在 `main` 中存在但未在 `arr` 中注册的键值对，均视为**数据损坏**，正常数据访问路径无法发现此类情况。

### 5.3 数据访问模式
系统支持两种数据访问模式，影响对缺失数据的处理行为：

#### 宽松模式 (Loose Mode)
- **行为**：自动补全缺失数据，保证查询流程完成。
- **返回**：完整的数据结构，缺失部分填充为 `null`（成员值）或 `[]`（数组），同时返回详细的错误信息。

#### 严格模式 (Strict Mode)  
- **行为**：遇到任何数据缺失（对象不存在、数组成员缺失、成员值缺失）立即终止查询。
- **返回**：`null`（表示查询因严格模式而失败），同时返回详细的错误信息。

### 5.4 数据完整性审计与幽灵成员
- **最高级别警报**：幽灵成员（在 `main` 存在但 `arr` 中未注册）表示**最高级别数据完整性警报**，表明写事务的原子性可能被破坏。
- **独立检测机制**：通过专用审计函数 `lmjcore_audit_object()` 进行检测，正常数据访问路径无法发现此类情况。
- **处理建议**：一旦发现幽灵成员，应立即进行数据修复和系统检查。
- **修复事务性**：专用的修复函数 `lmjcore_repair_object` 提供事务性保证，确保修复操作的原子性和安全性。
### 5.5 成员名称长度限制
- `main` 库 Key 由「17 字节指针 + 成员名」构成，受 LMDB 默认 511 字节上限约束，
- 故成员名最大允许 **493 字节**（二进制安全，含 UTF-8、哈希等任意编码）。
- 在内`put`前会检查member的长度是否超出最大字节,如果超出返`LMJCORE_ERR_MEMBER_TOO_LONG`

### 5.6 统一返回结构体内存归属
- 所有返回 `{data, errors}` 的 API 均写入调用方提供的缓冲区，
- 内核不执行堆分配，避免跨层内存管理歧义。

### 5.7 根指针持久化格式
- 内核工具函数统一输出 34 字符小写 HEX 字符串（无分隔符），
- 配置文件以文本形式保存即可，无需二进制。

## 六、设计优势总结

1.  **性能极致**：固定长度指针、二进制优先交互、扁平化存储。
2.  **灵活通用**：成员名支持任意字节序列，指针格式可转换，适应不同上层需求。
3.  **完整性保障**：明确的数据存在性规则和完整性审计机制。