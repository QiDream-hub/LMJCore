##  LMJCore 内核使用流程图

### 一、系统初始化流程
```mermaid
flowchart TD
    A[上层应用启动] --> B[调用 lmjcore_init]
    B --> C{判断是否传递<br>指针生成方法?}
    C -->|否| D[将使用默认<br>指针生成函数]
    C -->|是| E[使用传递的<br>指针生成函数]
    D --> F[初始化成功]
    E --> F
```

---

### 二、事务生命周期流程
```mermaid
flowchart TD
    A[上层应用] --> B{选择事务类型}
    B -->|读操作| C[创建只读事务<br>LMJCORE_TXN_READONLY]
    B -->|写操作| D[创建写事务<br>LMJCORE_TXN_WRITE]
    C --> E[设置读取模式]
    E --> F[执行数据读取操作]
    F --> G[提交或中止事务]
    D --> H[执行数据写入操作]
    H --> J{提交策略判断}
    J -->|批量累积/时间窗口/关键路径| I[提交事务]
    J -->|失败| K[中止事务并记录日志]
    K --> L[事务句柄失效]
    I --> L
```

---

### 三、数据读取流程（支持宽松/严格模式）
```mermaid
flowchart TD
    A[上层调用读取函数] --> B[传入指针与模式<br>（宽松/严格）]
    B --> C{指针是否存在？}
    C -->|否| D[严格模式：返回错误<br>宽松模式：返回null并记录错误]
    C -->|是| E[获取对象成员列表<br>（arr库）]
    E --> F[遍历成员列表<br>并发读取main库中的值]
    F --> G{是否存在缺失值？}
    G -->|是| H[严格模式：立即终止<br>宽松模式：补null并记录错误]
    G -->|否| I[组装完整对象]
    H --> I
    I --> J[返回统一结构<br>含data与errors]
```

---

### 四、数据写入流程（对象创建）
```mermaid
flowchart TD
    A[上层调用创建对象] --> B[生成唯一指针]
    B --> C{操作类型?}
    C -->|注册成员| D[调用 lmjcore_register_member]
    C -->|创建并赋值成员| E[在arr库注册成员列表]
    D --> F[提交事务]
    E --> G[在main库写入成员值]
    G --> F
```

---

### 五、数据审计与修复流程
```mermaid
flowchart TD
    A[上层调用审计函数] --> B[扫描arr库获取成员列表]
    B --> C[扫描main库匹配键值对]
    C --> D{发现幽灵成员？}
    D -->|是| E[记录错误类型：GHOST_MEMBER]
    D -->|否| F[状态：完整]
    E --> G[生成审计报告]
    F --> G
```
```mermaid
    flowchart TD
    A[上层调用修复函数] --> B{根据审计报告查找幽灵成员并确认?}
    B -->|否| C[记录错误]
    B -->|是| D[删除幽灵成员]
    D --> E
    C --> E[生成修复报告]
```
> 并发窗口说明：
> 修复函数启动独立写事务，期间**阻塞所有其他写事务**；
> 上层在调用审计后、修复前**必须主动终止业务写入**，
> 否则可能因幽灵成员继续产生而导致修复失败。